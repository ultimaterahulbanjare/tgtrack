<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UTS – Phase 1 Auth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      font-size: 24px;
      margin: 0 0 4px;
    }
    .muted { color: #9ca3af; font-size: 13px; }
    .tabs {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #0b1120;
      border-color: transparent;
      font-weight: 600;
    }
    .card {
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left,rgba(34,197,94,.08),transparent 55%);
      padding: 18px 16px 16px;
      margin-bottom: 18px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .pill {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      border: 1px solid #374151;
      color: #9ca3af;
    }
    form {
      display: grid;
      gap: 10px;
      margin-top: 4px;
    }
    label {
      font-size: 13px;
      margin-bottom: 3px;
      display: block;
    }
    input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
    }
    input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,.3);
    }
    button.primary {
      margin-top: 4px;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #02140a;
    }
    button.secondary {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: transparent;
      cursor: pointer;
      font-size: 12px;
      color: #e5e7eb;
    }
    .status {
      font-size: 12px;
      margin-top: 6px;
    }
    .status.ok { color: #4ade80; }
    .status.err { color: #f97373; }
    .status.neutral { color: #9ca3af; }
    .plans {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(150px,1fr));
      gap: 10px;
      margin: 8px 0 14px;
    }
    .plan-card {
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 10px 10px 12px;
      cursor: pointer;
      background: #020617;
    }
    .plan-card.selected {
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,.4);
      background:radial-gradient(circle at top,rgba(34,197,94,.12),#020617 60%);
    }
    .plan-name { font-weight:600;font-size:14px;margin-bottom:2px; }
    .plan-meta { font-size:12px;color:#9ca3af; }
    .tag {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid #374151;
      color:#d1d5db;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      font-size:12px;
    }
    th,td {
      padding:6px 4px;
      border-bottom:1px solid #111827;
      text-align:left;
    }
    th {
      font-weight:500;
      color:#9ca3af;
      font-size:11px;
    }
    tr:last-child td { border-bottom:none; }
    .layout-two {
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);
      gap:16px;
    }
    @media (max-width:768px){
      .layout-two { grid-template-columns:minmax(0,1fr); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_BASE = '';

    function useStatus() {
      const [msg,setMsg] = useState('');
      const [type,setType] = useState('neutral');
      const set = (m,t='neutral') => { setMsg(m); setType(t); };
      return [msg,type,set];
    }

    function SignupCard() {
      const [plan,setPlan] = useState('starter');
      const [form,setForm] = useState({name:'',email:'',password:''});
      const [msg,typ,setMsg] = useStatus();
      const [loading,setLoading] = useState(false);

      const plans = [
        {id:'single',name:'Single',channels:1,note:'Perfect for 1 channel'},
        {id:'starter',name:'Starter',channels:3,note:'For small teams'},
        {id:'pro',name:'Pro',channels:5,note:'Scaling agencies'},
        {id:'agency',name:'Agency',channels:10,note:'Big setups'}
      ];

      const onChange = e => setForm({...form,[e.target.name]:e.target.value});

      const onSubmit = async (e) => {
        e.preventDefault();
        setMsg('', 'neutral');
        if (!form.name || !form.email || !form.password) {
          setMsg('Please fill all fields.', 'err');
          return;
        }
        setLoading(true);
        try {
          const res = await fetch(API_BASE + '/api/auth/signup', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              name: form.name,
              email: form.email,
              password: form.password,
              plan
            })
          });
          const data = await res.json();
          if (!res.ok || !data.success) {
            setMsg(data.error || 'Signup failed', 'err');
          } else {
            setMsg('Account created! Wait for owner approval.', 'ok');
          }
        } catch (err) {
          console.error(err);
          setMsg('Network error during signup.', 'err');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="card">
          <div className="card-header">
            <div>
              <h2>Client signup</h2>
              <div className="muted">Select plan and create workspace.</div>
            </div>
            <div className="pill">Phase 1</div>
          </div>
          <div className="plans">
            {plans.map(p => (
              <div
                key={p.id}
                className={'plan-card ' + (plan===p.id?'selected':'')}
                onClick={() => setPlan(p.id)}
              >
                <div className="plan-name">{p.name}</div>
                <div className="plan-meta">Up to {p.channels} channels</div>
                <div className="muted" style={{fontSize:11,marginTop:3}}>{p.note}</div>
              </div>
            ))}
          </div>
          <form onSubmit={onSubmit}>
            <div>
              <label>Name / brand</label>
              <input
                name="name"
                value={form.name}
                onChange={onChange}
                placeholder="e.g. Rahul Trading Signals"
              />
            </div>
            <div>
              <label>Email</label>
              <input
                name="email"
                type="email"
                value={form.email}
                onChange={onChange}
                placeholder="you@example.com"
              />
            </div>
            <div>
              <label>Password</label>
              <input
                name="password"
                type="password"
                value={form.password}
                onChange={onChange}
                placeholder="••••••••"
              />
            </div>
            <button className="primary" type="submit" disabled={loading}>
              {loading ? 'Creating…' : 'Create account'}
            </button>
          </form>
          {msg && <div className={'status ' + typ}>{msg}</div>}
        </div>
      );
    }

    function ClientLoginCard() {
      const [form,setForm] = useState({email:'',password:''});
      const [msg,typ,setMsg] = useStatus();
      const [loading,setLoading] = useState(false);

      const onChange = e => setForm({...form,[e.target.name]:e.target.value});

      const onSubmit = async (e) => {
        e.preventDefault();
        setMsg('', 'neutral');
        if (!form.email || !form.password) {
          setMsg('Please fill email & password.', 'err');
          return;
        }
        setLoading(true);
        try {
          const res = await fetch(API_BASE + '/api/auth/login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(form)
          });
          const data = await res.json();
          if (!data.success) {
            if (data.status === 'pending') setMsg(data.message || 'Account pending approval.', 'neutral');
            else if (data.status === 'rejected') setMsg(data.message || 'Account rejected.', 'err');
            else setMsg(data.error || 'Login failed.', 'err');
          } else {
            setMsg('Logged in ✅ Redirecting to dashboard…', 'ok');
            setTimeout(() => {
              window.location.href = '/panel';
            }, 800);
          }
        } catch (err) {
          console.error(err);
          setMsg('Network error during login.', 'err');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="card">
          <div className="card-header">
            <div>
              <h2>Client login</h2>
              <div className="muted">Use email/password after approval.</div>
            </div>
            <div className="pill">Client</div>
          </div>
          <form onSubmit={onSubmit}>
            <div>
              <label>Email</label>
              <input
                name="email"
                type="email"
                value={form.email}
                onChange={onChange}
                placeholder="you@example.com"
              />
            </div>
            <div>
              <label>Password</label>
              <input
                name="password"
                type="password"
                value={form.password}
                onChange={onChange}
                placeholder="••••••••"
              />
            </div>
            <button className="primary" type="submit" disabled={loading}>
              {loading ? 'Signing in…' : 'Login'}
            </button>
          </form>
          {msg && <div className={'status ' + typ}>{msg}</div>}
        </div>
      );
    }

    function OwnerLoginCard() {
      const [form,setForm] = useState({email:'',password:''});
      const [msg,typ,setMsg] = useStatus();
      const [loading,setLoading] = useState(false);

      const onChange = e => setForm({...form,[e.target.name]:e.target.value});

      const onSubmit = async (e) => {
        e.preventDefault();
        setMsg('', 'neutral');
        if (!form.email || !form.password) {
          setMsg('Please fill email & password.', 'err');
          return;
        }
        setLoading(true);
        try {
          const res = await fetch(API_BASE + '/api/owner/login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(form)
          });
          const data = await res.json();
          if (!data.success) setMsg(data.error || 'Owner login failed.', 'err');
          else {
            setMsg('Owner logged in ✅ Redirecting…', 'ok');
            setTimeout(() => { window.location.href = '/dashboard'; }, 800);
          }
        } catch (err) {
          console.error(err);
          setMsg('Network error during owner login.', 'err');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="card">
          <div className="card-header">
            <div>
              <h2>Owner / admin login</h2>
              <div className="muted">Use seeded admin to approve clients.</div>
            </div>
            <div className="pill">Owner</div>
          </div>
          <form onSubmit={onSubmit}>
            <div>
              <label>Email</label>
              <input
                name="email"
                type="email"
                value={form.email}
                onChange={onChange}
                placeholder="admin@uts.local"
              />
            </div>
            <div>
              <label>Password</label>
              <input
                name="password"
                type="password"
                value={form.password}
                onChange={onChange}
                placeholder="Admin@123"
              />
            </div>
            <button className="primary" type="submit" disabled={loading}>
              {loading ? 'Signing in…' : 'Login as owner'}
            </button>
          </form>
          {msg && <div className={'status ' + typ}>{msg}</div>}
        </div>
      );
    }

    function OwnerPendingCard() {
      const [rows,setRows] = useState([]);
      const [msg,typ,setMsg] = useStatus();
      const [loading,setLoading] = useState(false);

      const load = async () => {
        setLoading(true);
        setMsg('', 'neutral');
        try {
          const res = await fetch(API_BASE + '/api/owner/clients/pending');
          const data = await res.json();
          if (!data.success) setMsg(data.error || 'Could not load pending clients.', 'err');
          else setRows(data.clients || []);
        } catch (err) {
          console.error(err);
          setMsg('Network error while loading clients.', 'err');
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => { load(); }, []);

      const act = async (id,mode) => {
        try {
          const res = await fetch(API_BASE + `/api/owner/clients/${id}/${mode}`, {
            method:'POST'
          });
          const data = await res.json();
          if (!data.success) setMsg(data.error || `Failed to ${mode} client.`, 'err');
          else {
            setMsg(`Client ${mode}d.`, 'ok');
            setRows(prev => prev.filter(r => r.id !== id));
          }
        } catch (err) {
          console.error(err);
          setMsg('Network error.', 'err');
        }
      };

      return (
        <div className="card">
          <div className="card-header">
            <div>
              <h2>Pending approvals</h2>
              <div className="muted">Read‑only list. Manage from Owner Super Dashboard.</div>
            </div>
            <button className="secondary" type="button" onClick={load}>Refresh</button>
          </div>
          {rows.length === 0 && (
            <div className="muted" style={{fontSize:12}}>No pending clients right now.</div>
          )}
          {rows.length > 0 && (
            <table>
              <thead>
                <tr>
                  <th>ID</th><th>Name</th><th>Slug</th><th>Plan</th><th>Max</th><th>Created</th>
                </tr>
              </thead>
              <tbody>
                {rows.map(r => (
                  <tr key={r.id}>
                    <td>{r.id}</td>
                    <td>{r.name}</td>
                    <td>{r.slug}</td>
                    <td><span className="tag">{r.plan}</span></td>
                    <td>{r.max_channels}</td>
                    <td>{r.created_at || '-'}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          )}
          {msg && <div className={'status ' + typ}>{msg}</div>}
        </div>
      );
    }

    function ClientMeCard() {
      const [info,setInfo] = useState(null);
      const [msg,typ,setMsg] = useStatus();

      const load = async () => {
        setMsg('', 'neutral');
        try {
          const res = await fetch(API_BASE + '/api/auth/me');
          const data = await res.json();
          if (!data.success) setMsg(data.error || 'Not logged in.', 'err');
          else {
            setInfo(data.user);
            setMsg('Session OK.', 'ok');
          }
        } catch (err) {
          console.error(err);
          setMsg('Network error.', 'err');
        }
      };

      useEffect(() => { load(); }, []);

      return (
        <div className="card">
          <div className="card-header">
            <div>
              <h2>Client session preview</h2>
              <div className="muted">This will power Phase 2 dashboard.</div>
            </div>
            <button className="secondary" type="button" onClick={load}>Refresh</button>
          </div>
          {info ? (
            <div style={{fontSize:13}}>
              <div><strong>Name:</strong> {info.name}</div>
              <div><strong>Email:</strong> {info.email}</div>
              <div><strong>Plan:</strong> {info.plan} (max {info.max_channels} channels)</div>
              <div><strong>Client ID:</strong> {info.client_id}</div>
              <div><strong>Slug:</strong> {info.slug}</div>
            </div>
          ) : (
            <div className="muted" style={{fontSize:12}}>
              Not logged in yet. Use client login tab first.
            </div>
          )}
          {msg && <div className={'status ' + typ}>{msg}</div>}
        </div>
      );
    }

    function App() {
      const [tab,setTab] = useState('signup');
      return (
        <div className="shell">
          <h1>Universal Tracking – Phase 1</h1>
          <div className="muted">
            Auth + plan selection + owner approval on top of your existing tracking backend.
          </div>
          <div className="tabs">
            <button className={'tab-btn ' + (tab==='signup'?'active':'')} onClick={()=>setTab('signup')}>
              1) Client signup
            </button>
            <button className={'tab-btn ' + (tab==='client-login'?'active':'')} onClick={()=>setTab('client-login')}>
              2) Client login
            </button>
            <button className={'tab-btn ' + (tab==='client-me'?'active':'')} onClick={()=>setTab('client-me')}>
              3) Session preview
            </button>
            <button className={'tab-btn ' + (tab==='owner'?'active':'')} onClick={()=>setTab('owner')}>
              4) Owner approvals
            </button>
          </div>

          {tab === 'signup' && <SignupCard />}
          {tab === 'client-login' && (
            <div className="layout-two">
              <ClientLoginCard />
              <ClientMeCard />
            </div>
          )}
          {tab === 'client-me' && <ClientMeCard />}
          {tab === 'owner' && (
            <div className="layout-two">
              <OwnerLoginCard />
              <OwnerPendingCard />
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
